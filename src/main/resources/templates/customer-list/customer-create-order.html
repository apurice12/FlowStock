<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen font-sans">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="ml-64">
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Header -->
        <div class="mb-6 animate-slide-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a th:href="@{/customer/details/{id}(id=${customer.id})}" class="p-2 hover:bg-white rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">Create Order</h1>
                        <p class="text-slate-600">Customer: <span class="font-semibold" th:text="${customer.name}"></span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleCart()" class="lg:hidden px-5 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        View Cart (<span id="mobileCartCount">0</span>)
                    </button>
                </div>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="mb-6 animate-slide-in" th:if="${not #lists.isEmpty(categories)}">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm font-semibold text-slate-700">Categories:</span>
                    <button onclick="filterByCategory(null)"
                            class="category-filter active px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            data-category="">
                        All Products
                    </button>
                    <button th:each="category : ${categories}"
                            onclick="filterByCategory(this.dataset.category)"
                            th:data-category="${category.id}"
                            th:text="${category.name}"
                            class="category-filter px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        Category
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Products List - Takes 3 columns on large screens -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200">
                    <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Products</h2>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <input type="text" id="productSearch" placeholder="Search products by name or code..." onkeyup="filterProducts()" class="w-full pl-12 pr-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"/>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead>
                            <tr class="bg-gradient-to-r from-slate-800 to-slate-700 text-white">
                                <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">
                                    Product
                                </th>
                                <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">
                                    Category
                                </th>
                                <th class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider">
                                    Stock
                                </th>
                                <th class="py-3 px-4 text-right text-xs font-semibold uppercase tracking-wider">
                                    Price
                                </th>
                                <th class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider">
                                    Action
                                </th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100">
                            <tr th:each="product : ${products}"
                                class="product-card hover:bg-slate-50 transition-colors"
                                th:data-name="${product.name}"
                                th:data-code="${product.code}"
                                th:data-category="${product.productCategory != null ? product.productCategory.id : ''}">
                                <td class="py-3 px-4">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <div class="w-2 h-2 bg-emerald-500 rounded-full flex-shrink-0"></div>
                                            <span class="text-sm font-medium text-slate-900" th:text="${product.name}"></span>
                                        </div>
                                        <span class="text-xs text-slate-500 font-mono ml-4" th:text="${product.code}"></span>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                          th:text="${product.productCategory != null ? product.productCategory.name : 'N/A'}">
                                        Category
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-800" th:text="${product.quantity}"></span>
                                </td>
                                <td class="py-3 px-4 text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        <span class="text-sm font-semibold text-slate-900" th:text="${#numbers.formatDecimal(product.price, 1, 2)}"></span>
                                        <span class="text-xs text-slate-500 font-medium">RON</span>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex items-center justify-center">
                                        <button onclick="addToCart(this)"
                                                th:data-id="${product.id}"
                                                th:data-name="${product.name}"
                                                th:data-code="${product.code}"
                                                th:data-price="${product.price}"
                                                th:data-stock="${product.quantity}"
                                                class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-all flex items-center gap-1.5">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                            </svg>
                                            Add
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="border-t border-slate-200 bg-slate-50 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-slate-600">
                                Showing <span id="pageStart" class="font-semibold">1</span> to
                                <span id="pageEnd" class="font-semibold">10</span> of
                                <span id="totalProducts" class="font-semibold">0</span> products
                            </div>

                            <div class="flex items-center gap-2">
                                <button onclick="previousPage()" id="prevButton"
                                        class="px-3 py-1.5 bg-white hover:bg-slate-100 text-slate-700 font-medium rounded-lg border border-slate-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                                        disabled>
                                    Previous
                                </button>

                                <div id="pageNumbers" class="flex items-center gap-1"></div>

                                <button onclick="nextPage()" id="nextButton"
                                        class="px-3 py-1.5 bg-white hover:bg-slate-100 text-slate-700 font-medium rounded-lg border border-slate-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                    Next
                                </button>
                            </div>

                            <div class="flex items-center gap-2">
                                <label class="text-sm text-slate-600">Per page:</label>
                                <select id="itemsPerPage" onchange="changeItemsPerPage()"
                                        class="px-2 py-1.5 bg-white border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-blue-500">
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart - Right Side (1 column) -->
            <div class="lg:col-span-1" id="cartSection">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 lg:sticky lg:top-6">
                    <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                                </svg>
                                <h2 class="text-xl font-bold text-slate-800">Cart</h2>
                            </div>
                            <span id="cartCount" class="bg-blue-600 text-white text-sm font-bold px-3 py-1 rounded-full">0</span>
                        </div>
                    </div>

                    <div id="cartItems" class="p-4 space-y-3 max-h-[400px] overflow-y-auto"></div>

                    <div id="emptyCart" class="p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        <p class="text-slate-500 font-medium">Cart is empty</p>
                        <p class="text-sm text-slate-400 mt-1">Add products to start</p>
                    </div>

                    <div class="border-t border-slate-200 p-6 bg-slate-50">
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-slate-600">
                                <span>Items:</span>
                                <span id="itemCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-slate-900">
                                <span>Total:</span>
                                <span id="totalAmount" class="text-blue-600">0.00 RON</span>
                            </div>
                        </div>

                        <button id="createOrderBtn" onclick="createOrder()" disabled class="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Create Order
                        </button>

                        <button onclick="clearCart()" class="w-full mt-2 px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all">Clear Cart</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex justify-center items-center z-50 p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
        <div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 text-center mb-2">Order Created!</h3>
        <p class="text-slate-600 text-center mb-6">Your order has been successfully created.</p>
        <button onclick="goBackToCustomer()" class="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-all">Back to Customer</button>
    </div>
</div>

<div id="loadingModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex justify-center items-center z-50" style="display: none;">
    <div class="bg-white p-8 rounded-2xl shadow-2xl">
        <div class="flex flex-col items-center gap-4">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-slate-200 rounded-full"></div>
                <div class="absolute top-0 left-0 w-16 h-16 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p class="text-slate-700 font-medium">Creating order...</p>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const customerId = /*[[${customer.id}]]*/ 0;
    let cart = [];

    // Pagination variables
    let currentPage = 1;
    let itemsPerPageValue = 10;
    let allProducts = [];
    let filteredProducts = [];

    // Initialize pagination
    document.addEventListener('DOMContentLoaded', function() {
        allProducts = Array.from(document.querySelectorAll('.product-card'));
        filteredProducts = [...allProducts];

        // Initialize category filter buttons
        const filterButtons = document.querySelectorAll('.category-filter');
        filterButtons.forEach(btn => {
            if (btn.dataset.category === '') {
                btn.classList.add('bg-blue-500', 'text-white');
            } else {
                btn.classList.add('bg-slate-100', 'text-slate-700', 'hover:bg-slate-200');
            }
        });

        renderPagination();
    });

    function renderPagination() {
        const totalItems = filteredProducts.length;
        const totalPages = Math.ceil(totalItems / itemsPerPageValue);

        const pageStart = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPageValue + 1;
        const pageEnd = Math.min(currentPage * itemsPerPageValue, totalItems);

        document.getElementById('pageStart').textContent = pageStart;
        document.getElementById('pageEnd').textContent = pageEnd;
        document.getElementById('totalProducts').textContent = totalItems;

        // Show/hide products based on current page
        filteredProducts.forEach((product, index) => {
            const itemPage = Math.floor(index / itemsPerPageValue) + 1;
            product.style.display = itemPage === currentPage ? '' : 'none';
        });

        // Hide all products not in filtered list
        allProducts.forEach(product => {
            if (!filteredProducts.includes(product)) {
                product.style.display = 'none';
            }
        });

        // Update buttons
        document.getElementById('prevButton').disabled = currentPage === 1;
        document.getElementById('nextButton').disabled = currentPage >= totalPages || totalItems === 0;

        // Render page numbers
        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';

        if (totalPages <= 1) return;

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.onclick = () => goToPage(i);

            if (i === currentPage) {
                button.className = 'px-3 py-1 bg-blue-500 text-white font-semibold rounded-lg text-sm';
            } else {
                button.className = 'px-3 py-1 bg-white hover:bg-slate-100 text-slate-700 font-medium rounded-lg border border-slate-300 transition-all text-sm';
            }

            pageNumbers.appendChild(button);
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderPagination();
    }

    function previousPage() {
        if (currentPage > 1) goToPage(currentPage - 1);
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredProducts.length / itemsPerPageValue);
        if (currentPage < totalPages) goToPage(currentPage + 1);
    }

    function changeItemsPerPage() {
        itemsPerPageValue = parseInt(document.getElementById('itemsPerPage').value);
        currentPage = 1;
        renderPagination();
    }

    function filterProducts() {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();

        filteredProducts = allProducts.filter(card => {
            const name = card.dataset.name.toLowerCase();
            const code = card.dataset.code.toLowerCase();
            const categoryMatch = selectedCategory === null || card.dataset.category === String(selectedCategory);
            const searchMatch = name.includes(searchTerm) || code.includes(searchTerm);

            return categoryMatch && searchMatch;
        });

        currentPage = 1;
        renderPagination();
    }

    let selectedCategory = null;

    function filterByCategory(categoryId) {
        selectedCategory = categoryId;
        const filterButtons = document.querySelectorAll('.category-filter');

        filterButtons.forEach(btn => {
            if (btn.dataset.category === String(categoryId) || (categoryId === null && btn.dataset.category === '')) {
                btn.classList.add('active');
                btn.classList.remove('bg-slate-100', 'text-slate-700', 'hover:bg-slate-200');
                btn.classList.add('bg-blue-500', 'text-white');
            } else {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-slate-100', 'text-slate-700', 'hover:bg-slate-200');
            }
        });

        filterProducts();
    }

    function addToCart(button) {
        const productId = button.dataset.id;
        const productName = button.dataset.name;
        const productCode = button.dataset.code;
        const productPrice = parseFloat(button.dataset.price);
        const stock = parseInt(button.dataset.stock);

        const existingIndex = cart.findIndex(item => item.productId === productId);

        if (existingIndex > -1) {
            if (cart[existingIndex].quantity >= stock) {
                alert('Not enough stock!');
                return;
            }
            cart[existingIndex].quantity += 1;
        } else {
            cart.push({
                productId: productId,
                productName: productName,
                productCode: productCode,
                price: productPrice,
                quantity: 1,
                stock: stock
            });
        }

        updateCart();
        button.classList.add('scale-90');
        setTimeout(() => button.classList.remove('scale-90'), 100);
    }

    function updateQuantity(productId, change) {
        const index = cart.findIndex(item => item.productId === productId);
        if (index > -1) {
            const newQty = cart[index].quantity + change;

            if (newQty <= 0) {
                removeFromCart(productId);
            } else if (newQty <= cart[index].stock) {
                cart[index].quantity = newQty;
                updateCart();
            } else {
                alert('Not enough stock!');
            }
        }
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.productId !== productId);
        updateCart();
    }

    function clearCart() {
        if (cart.length > 0 && confirm('Clear cart?')) {
            cart = [];
            updateCart();
        }
    }

    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const emptyCart = document.getElementById('emptyCart');
        const createOrderBtn = document.getElementById('createOrderBtn');
        const cartCount = document.getElementById('cartCount');
        const itemCount = document.getElementById('itemCount');

        if (cart.length === 0) {
            cartItems.innerHTML = '';
            emptyCart.style.display = 'block';
            createOrderBtn.disabled = true;
            cartCount.textContent = '0';
            itemCount.textContent = '0';
            document.getElementById('totalAmount').textContent = '0.00 RON';
        } else {
            emptyCart.style.display = 'none';
            createOrderBtn.disabled = false;

            let html = '';
            let total = 0;
            let totalItems = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                totalItems += item.quantity;

                html += `
                    <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <p class="font-semibold text-slate-900 text-sm">${item.productName}</p>
                                <p class="text-xs text-slate-500 font-mono">${item.productCode}</p>
                                <p class="text-xs text-slate-600 mt-1">${item.price.toFixed(2)} RON each</p>
                            </div>
                            <button onclick="removeFromCart('${item.productId}')" class="text-red-600 hover:text-red-700 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-2 bg-white rounded-lg border border-slate-300">
                                <button onclick="updateQuantity('${item.productId}', -1)" class="px-2 py-1 hover:bg-slate-100 rounded-l-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                    </svg>
                                </button>
                                <span class="px-3 font-semibold text-slate-900">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.productId}', 1)" class="px-2 py-1 hover:bg-slate-100 rounded-r-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </button>
                            </div>
                            <span class="font-bold text-slate-900">${itemTotal.toFixed(2)} RON</span>
                        </div>
                    </div>
                `;
            });

            cartItems.innerHTML = html;
            cartCount.textContent = cart.length;
            itemCount.textContent = totalItems;
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' RON';

            const mobileCount = document.getElementById('mobileCartCount');
            if (mobileCount) {
                mobileCount.textContent = cart.length;
            }
        }
    }

    function toggleCart() {
        const cartSection = document.getElementById('cartSection');
        if (cartSection.style.display === 'none') {
            cartSection.style.display = 'block';
        } else {
            cartSection.style.display = 'none';
        }
    }

    async function createOrder() {
        if (cart.length === 0) {
            alert('Add products to cart first!');
            return;
        }

        console.log('=== STARTING ORDER CREATION ===');
        console.log('Customer ID:', customerId);
        console.log('Cart contents:', JSON.stringify(cart, null, 2));

        document.getElementById('loadingModal').style.display = 'flex';

        try {
            console.log('Step 1: Creating order...');
            const orderResponse = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerId: customerId })
            });

            console.log('Order Response Status:', orderResponse.status);

            const orderResponseText = await orderResponse.text();
            console.log('Order Response Body (raw):', orderResponseText);

            if (!orderResponse.ok) {
                throw new Error(`Failed to create order. Status: ${orderResponse.status}. Response: ${orderResponseText}`);
            }

            let order;
            try {
                order = JSON.parse(orderResponseText);
                console.log('Parsed Order:', order);
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                throw new Error('Invalid JSON response from server: ' + orderResponseText);
            }

            console.log(`Step 2: Adding ${cart.length} items to order #${order.id}...`);

            for (let i = 0; i < cart.length; i++) {
                const item = cart[i];
                console.log(`\nAdding item ${i + 1}/${cart.length}:`, item);

                const itemPayload = {
                    productId: parseInt(item.productId),
                    quantity: parseInt(item.quantity),
                    unitPrice: parseFloat(item.price)
                };
                console.log('Item Payload:', itemPayload);

                const itemResponse = await fetch(`/api/order/${order.id}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemPayload)
                });

                console.log(`Item ${i + 1} Response Status:`, itemResponse.status);

                const itemResponseText = await itemResponse.text();
                console.log(`Item ${i + 1} Response Body (raw):`, itemResponseText);

                if (!itemResponse.ok) {
                    throw new Error(`Failed to add item "${item.productName}". Status: ${itemResponse.status}. Response: ${itemResponseText}`);
                }

                console.log(`âœ“ Item ${i + 1} added successfully`);
            }

            console.log('=== ORDER CREATED SUCCESSFULLY ===');

            document.getElementById('loadingModal').style.display = 'none';
            document.getElementById('successModal').style.display = 'flex';
            cart = [];
            updateCart();

        } catch (error) {
            document.getElementById('loadingModal').style.display = 'none';
            console.error('=== ORDER CREATION FAILED ===');
            console.error('Error:', error);
            console.error('Error Message:', error.message);

            alert('Failed to create order:\n\n' + error.message + '\n\nCheck browser console (F12) for details.');
        }
    }

    function goBackToCustomer() {
        window.location.href = '/customer/details/' + customerId;
    }
    /*]]>*/
</script>

</body>
</html>